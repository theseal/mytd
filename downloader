#!/usr/local/bin/python3

import feedparser
import json
import logging
import os
import re
import requests
import sys
import threading
import time
import yt_dlp

CHAT_ID = int(os.environ["CHAT_ID"])
TOKEN = os.environ["TOKEN"]


def notify(message, reference=None):
    url = f"https://api.telegram.org/bot{TOKEN}/sendMessage?chat_id={CHAT_ID}&text={message}&allow_sending_without_reply=True"
    if reference:
        url += f"&reply_to_message_id={reference}"
    r = requests.get(url)


def download(url):
    ydl_opts = {
        "download_archive": "/config/download-archive",
        "ignoreerrors": True,
        "writesubtitles": True,
        "writeautomaticsub": True,
        "subtitleslangs": ["sv.*", "en.*"],
        "writethumbnail": True,
        "outtmpl": "/data/%(uploader)s/%(timestamp)s/S01E%(upload_date)s - %(uploader)s - %(title)s [%(id)s].%(ext)s",
        # "verbose": True,
    }
    uploader = "NA"
    title = "NA"
    result = dict()
    with yt_dlp.YoutubeDL(ydl_opts) as ydl:
        info = ydl.extract_info(url, download=True)
        info = ydl.sanitize_info(info)
        if info:
            uploader = info["uploader"]
            title = info["title"]

    result["uploader"] = uploader
    result["title"] = title

    return result


def rss():
    while True:
        channels = open("/config/channel-file", "r")
        for channel in channels:
            url = f"https://www.youtube.com/feeds/videos.xml?channel_id={channel}"
            feed = feedparser.parse(url)

            for post in feed.entries:
                download(url)

            time.sleep(30)

        channels.close

        time.sleep(3600)


def telegram():
    offset = 0

    while True:
        offset += 1
        url = f"https://api.telegram.org/bot{TOKEN}/getUpdates?offset={offset}"

        r = requests.get(url)
        data = r.json()
        if not data["result"]:
            time.sleep(60)

        for result in data["result"]:
            offset = result["update_id"]
            from_id = result["message"]["from"]["id"]
            # Only allow me
            if from_id != CHAT_ID:
                continue
            text = result["message"]["text"]
            message_id = result["message"]["message_id"]

            if m := re.match("^(https?://[^\s]+)", text):
                url = m.group(1)
            else:
                continue

            download(url)
            message = "K√∂at üëç"
            notify(message=message, reference=message_id)


x = threading.Thread(target=rss)
y = threading.Thread(target=telegram)
x.start()
y.start()

# For testing
# URL = "https://www.youtube.com/watch?v=BaW_jenozKc"
# URL = 'https://www.youtube.com/watch?v=PEHoaB6X3cs'
# URL = 'https://vimeo.com/731378604'
# download(URL)
